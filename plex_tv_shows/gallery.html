<html>
  <!--
      
      ThinGallery
      ===========
      
      https://github.com/gfwilliams/ThinGallery
      
      Copyright 2016 Gordon Williams, gw@pur3.co.uk (Licensed as MPLv2)
      
      A single-file gallery webpage. This uses EXIF thumbnails, XMLHttpRequest Range headers,
      and your web server's own index pages to quickly display thumbnails for a directory without
      having to fully load every image file, and without needing ANY server-side scripting.
      
      Usage
    -----
      
      * Put `gallery.html` in the folder that contains your photos.
      * Don't rename it to `index.html` as the web server's own index.html is required in order to list the photos
      * Open gallery.html with a web browser, and enjoy
      
    -->
  <head>
    <title>Gallery</title>
    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Gallery">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <script type="text/javascript" charset="utf-8">
      
      // Mobile Safari in standalone mode
      if(("standalone" in window.navigator) && window.navigator.standalone){
	  // If you want to prevent remote links in standalone web apps opening Mobile Safari, change 'remotes' to true
	  var noddy, remotes = true;
	  document.addEventListener('click', function(event) {
              noddy = event.target;
              // Bubble up until we hit link or top HTML element. Warning: BODY element is not compulsory so better to stop on HTML
              while(noddy.nodeName !== "A" && noddy.nodeName !== "HTML") {
		  noddy = noddy.parentNode;
              }
              if('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(document.location.host) !== -1 || remotes)) {
		  event.preventDefault();
		  document.location.href = noddy.href;
              }
	  },false);
      }
    </script>
    <style>
      :root {
	  --thumb-width: 240px;
	  --thumb-height: 240px;
      }

      body {
          color: white;
          background-color: black;
      }
      a > .thumb { color: #fff; }
      .thumb {
          position: relative;
          display: inline-block;
          width:var(--thumb-width); height:var(--thumb-height);
          margin: 4px;
          cursor: pointer;
          overflow: hidden;
      }
      .caption {
          text-align: center;
          font-size: 80%;
          font-family: Helvetica, Arial, Sans-Serif;
          text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;
          position: absolute;
          width:var(--thumb-width);
          bottom:0px;
      }
      .thumbicon {
          position: absolute;
          font-size:48px;
          left:50%;
          top:50%;
          transform: translateX(-50%) translateY(-50%);
      }
      .thumbimage {
          position:absolute;top:0px;left:0px;
          width:var(--thumb-width); height:var(--thumb-height);
          background-position: center;
          background-repeat: no-repeat;
          background-size: contain;
      }
      .fullscreen {
          position: absolute;
          width: 100%;
          min-height: 100%;
          left: 0;
          top: 0;
      }
      #modal {
          background-color: rgba(0,0,0,0.8);
      }
      #bigimage {
          position: absolute;
          width: 100%;
          min-height: 100%;
          left: 0;
          top: 0;
          background-position: center;
          background-repeat: no-repeat;
          background-size: contain;
      }
      #loadingimage {
          position: absolute;
          width: 100%;
          min-height: 100%;
          left: 0;
          top: 0;
          background-position: center;
          background-repeat: no-repeat;
          background-size: contain;
      }
      #left,#right,#maximise {
          position:absolute;
          font-size:96px;
          font-weight: bold;
      }
      #left,#right {
          top: 50%; transform: translateY(-50%);
      }
      #left {  left:10px; cursor:pointer; }
      #right { right:10px; cursor:pointer; }
      #maximise { right:10px;bottom:10px; cursor:pointer; }
      #left,#right,#maximise {
          text-shadow: 4px 0 0 #000, 0 -4px 0 #000, 0 4px 0 #000, -4px 0 0 #000, -3px -3px 0 #000, 3px -3px 0 #000, 3px 3px 0 #000, -3px -3px 0 #000;;
      }
    </style>
  </head>
  <body>
    
    <div id="thumbs"></div>
    <script>
      
      var THUMB_SIZE = 240; // size when we have to load the full image and resize it
      var MAX_CONCURRENT_REQ = 2;
      var requestsInProgress = 0;
      var requestsQueued = [];

      var baseURL = "";

      var imageURLs = [];
      var imageInfo = {};
      var showingImage; // currently loading/showing image
      var imageLoader, nextImageLoader, prevImageLoader;

      // Get a thumbnail from EXIF data
      function getThumbFromFullImage(url, callback) {
	  var img = document.createElement('img');
	  img.onload = function () {
	      var oc = document.createElement('canvas'),
		  octx = oc.getContext('2d');
	      if (img.width > img.height) {
		  oc.width = THUMB_SIZE;
		  oc.height = THUMB_SIZE * img.height / img.width;
	      } else {
		  oc.width = THUMB_SIZE * img.width / img.height;
		  oc.height = THUMB_SIZE;
	      }
	      octx.drawImage(img, 0, 0, oc.width, oc.height);
	      callback(oc.toDataURL());
	  };
	  img.src = url;
      }

      // Get a thumbnail from EXIF data
      function getEXIFThumb(url, arraybuffer, callback) {
	  var arr = new Uint8Array(arraybuffer);
	  if (arr[0]!=0xFF || arr[1]!=0xD8) {
	      console.warn(url+" is not a valid JPEG");
	      return callback(url);
	  }
	  var offs = 2;
	  if (arr[offs]==0xFF && arr[offs+1]==0xE0) {
	      offs += arr[offs+3] + 2;
	  }
	  if (arr[offs]!=0xFF || arr[offs+1]!=0xE1) {
	      console.warn(url+" doesn't have EXIF tag at "+offs);
	      return callback(url);
	  }
	  var len = (arr[offs+2]<<8)|arr[offs+3];
	  if (len > arr.length) console.log("EXIF is "+len+" bytes long but we have only "+arr.length);
	  if (arr[offs+4]!=0x45 || arr[offs+5]!=0x78 || arr[offs+6]!=0x69 || arr[offs+7]!=0x66) {
	      console.warn(url+" doesn't have 'Exif' marker at "+offs);
	      return callback(url);
	  }
	  // Move on to TIFF header
	  offs += 10;
	  var rd16, rd32;
	  if (arr[offs]==0x49 && arr[offs+1]==0x49) {
	      // Intel align
	      rd16 = function(a) { return arr[a] | (arr[a+1]<<8); }
	      rd32 = function(a) { return arr[a] | (arr[a+1]<<8) | (arr[a+2]<<16) | (arr[a+3]<<24); }
	  } else if (arr[offs]==0x4D && arr[offs+1]==0x4D) {
	      // Motorola align
	      rd16 = function(a) { return arr[a+1] | (arr[a]<<8); }
	      rd32 = function(a) { return arr[a+3] | (arr[a+2]<<8) | (arr[a+1]<<16) | (arr[a]<<24); }
	  } else {
	      console.warn(url+" unknown byte alignment "+arr[offs]+","+arr[offs+1]);
	      return callback(url);
	  }
	  if (rd16(offs+2) != 0x002A) {
	      console.warn(url+" expecting TAG mark");
	      return callback(url);
	  }
	  // move on to IFD - Image file directory
	  offs+=rd32(offs+4);
	  // get tags
	  var tags = rd16(offs);
	  if (tags>100) {
	      console.warn(url+" too many EXIF tags!");
	      return callback(url);
	  }
	  offs += 2;
	  // iterate over tags
	  var thumbOrientation;
	  for (var i=0;i<tags;i++) {
	      var tag = rd16(offs+i*12);
	      //console.log(tag.toString(16));
	      if (tag==0x0112) { // JPEG orientation
		  thumbOrientation = rd32(offs+i*12+8);
	      }
	  }
	  // skip to next IFD
	  offs = rd32(offs + tags*12);
	  if (offs==0) {
	      console.warn(url+" no second IFD.");
	      return callback(url);
	  }
	  offs += 12;
	  var tags = rd16(offs);
	  if (tags>300) {
	      console.warn(url+" too many EXIF tags ("+tags+") in second IFD!");
	      return callback(url);
	  }
	  offs += 2;
	  // iterate over tags
	  var thumbOffset, thumbLen;
	  for (var i=0;i<tags;i++) {
	      var tag = rd16(offs+i*12);
	      //console.log(tag.toString(16));
	      if (tag==0x0201) thumbOffset = rd32(offs + i*12 + 8)+12; // ?
	      if (tag==0x0202) thumbLen = rd32(offs + i*12 + 8);
	  }
	  if (thumbOffset && thumbLen) {
	      //console.log("Thumb at",thumbOffset,"size",thumbLen,"tag",arr[thumbOffset].toString(16),arr[thumbOffset+1].toString(16));
	      var data = arr.subarray(thumbOffset, thumbOffset+thumbLen);
	      var blob = new Blob( [ data ], { type: "image/jpeg" } );
	      var urlCreator = window.URL || window.webkitURL;
	      var imageURL = urlCreator.createObjectURL( blob );
	      var rotation = 0;
	      if (thumbOrientation==6) rotation = 90;
	      callback(imageURL, rotation);
	  } else {
	      /* No thumbnail */
	      callback(url);
	  }
      }

      function getImageThumbnail(url, finishedCb, thumbCb) {
	  //console.log("Loading "+url);
	  var xhr = new XMLHttpRequest;
	  xhr.open('GET', url, true);
	  xhr.responseType = "arraybuffer";
	  xhr.setRequestHeader('Range', 'bytes=0-60000');
	  xhr.onload = function (oEvent) {
	      getEXIFThumb(url, xhr.response, function(url, rotation) {
		  thumbCb(url, rotation);
		  finishedCb();
	      });
	  };
	  xhr.send(null);
      }

      function getImageThumbnailThrottled(url, cb, passURL) {
	  if (requestsInProgress < MAX_CONCURRENT_REQ) {
	      requestsInProgress++;

	      function finishedCb() {
		  requestsInProgress--;
		  if (requestsQueued.length) {
		      var r = requestsQueued.shift();
		      getImageThumbnailThrottled(r.url, r.cb, r.passURL);
		  }
	      }

	      if (passURL) {
		  getThumbFromFullImage(url, function(url) {
		      cb(url);
		      finishedCb();
		  });
	      } else {
		  getImageThumbnail(url, finishedCb, cb);
	      }
	  } else {
	      //console.log("Delayed "+url);
	      requestsQueued.push({url:url,cb:cb,passURL:passURL});
	  }
      }

      function addDeferredThumb(thumbs, href) {
	  var niceName;
	  if (href.lastIndexOf("/")>=0)
	      niceName = href.substr(href.lastIndexOf("/")+1);
	  else
	      niceName = href;

	  function thumbLoaded(url, rotate) {
	      imageInfo[href].thumb = url;
	      im.innerHTML =
		  '<div class="thumbimage" style="background-image:url('+url+');transform:rotate('+rotate+'deg)"></div>'+
		  '<div class="caption">'+decodeURIComponent(niceName)+'</div>';
	  }

	  var im = document.createElement("DIV");
	  im.innerHTML = '<div class="caption">'+decodeURIComponent(niceName)+'</div><div class="thumbicon">&#8987;</div>';
	  im.className = "thumb";
	  im.setAttribute("href", href);
	  im.onclick = onThumbClicked;
	  im = thumbs.appendChild(im);
	  getImageThumbnailThrottled(href, function(url,rotate) {
	      if (url == href) {
		  // We use getImageThumbnailThrottled so we can make sure
		  // that full images get loaded AFTER all the thumbnails
		  getImageThumbnailThrottled(url, thumbLoaded, true);
	      } else {
		  thumbLoaded(url, rotate);
	      }
	  });
      }

      function addFolder(thumbs, href) {
	  var niceName = href.substr(0,href.length-1);
	  if (niceName.lastIndexOf("/")>=0)
	      niceName = niceName.substr(niceName.lastIndexOf("/")+1);
	  if (href.length < baseURL.length) niceName = "[BACK]";

	  var a = document.createElement("A");
	  a.href = window.location.pathname+"?"+href;
	  a.innerHTML = '<div class="thumb folder"><div class="caption">'+decodeURIComponent(niceName)+'</div><div class="thumbicon">&#128193;</div></div>';
	  thumbs.appendChild(a);
      }

      function processIndexPage() {
	  //console.log(this.responseXML.title);
	  var thumbs = document.getElementById("thumbs");
	  var elements = this.responseXML.getElementsByTagName("a");
	  var handled = [];
	  for (var i=0;i<elements.length;i++) {
	      var href = elements[i].href;
	      if (handled.indexOf(href)>=0) continue;
	      if (href[href.length-1]=="/" && href!==baseURL) {
		  handled.push(href);
		  addFolder(thumbs, href);
	      }
	  }
	  for (var i=0;i<elements.length;i++) {
	      var href = elements[i].href;
	      var hrefl = href.toLowerCase();
	      if (hrefl.substr(-4)==".jpg" || hrefl.substr(-5)==".jpeg" || hrefl.substr(-4)==".png" || hrefl.substr(-4) == ".svg") {
		  if (handled.indexOf(href)>=0) continue;
		  handled.push(href);
		  imageURLs.push(href);
		  imageInfo[href] = { thumb : "" };
		  addDeferredThumb(thumbs, href);
	      }
	  }
	  document.getElementById("left").setAttribute("style","visibility:inherit");
	  document.getElementById("right").setAttribute("style","visibility:inherit");
	  document.getElementById("maximise").setAttribute("style","visibility:inherit");
	  document.getElementById("modal").setAttribute("style","visibility:hidden");
      }



      function loadAllImages(url) {
	  var xhr = new XMLHttpRequest();
	  xhr.onload = processIndexPage;
	  baseURL = url;
	  xhr.open("GET", baseURL);
	  xhr.responseType = "document";
	  xhr.send();
      }

      function loadImage(url) {
	  document.getElementById("bigimage").setAttribute("style","background-image:url("+imageInfo[url].thumb+")");
	  imageLoader.onload = function() {
	      console.log("Full image loaded. Loading next and prev.");
	      var i = imageURLs.indexOf(showingImage);
	      if (i>=0) {
		  if (i>0) prevImageLoader.src = imageURLs[i-1]+"?rand";
		  if (i<imageURLs.length-1) nextImageLoader.src = imageURLs[i+1]+"?rand";
	      }
	  };
	  imageLoader.src = url+"?rand";
	  document.getElementById("loadingimage").setAttribute("style","background-image:url("+url.replace(/\(/g, "\\(").replace(/\)/g, "\\)")+"?rand)");
	  showingImage = url;
      }

      function onThumbClicked(e) {
	  e.preventDefault();
	  var url = e.currentTarget.getAttribute("href");
	  console.log("Clicked "+url);
	  if (e.ctrlKey) {
	      window.open(url, '_blank');
	  } else {
	      document.getElementById("modal").setAttribute("style","display:block;top:"+window.scrollY+"px");
	      loadImage(url);
	  }
      }

      function onModalClicked(e) {
	  e.preventDefault();
	  if (e.target.id=="left" || e.target.id=="right" || e.target.id=="maximise") return;
	  document.getElementById("modal").setAttribute("style","visibility:hidden");
	  document.getElementById("bigimage").setAttribute("style","");
	  document.getElementById("loadingimage").setAttribute("style","");
	  showingImage = null;
      }

      function onChangeModal(e, dir) {
	  e.preventDefault();
	  var i = imageURLs.indexOf(showingImage);
	  if (i<0) i=0;
	  i += dir;
	  if (i<0) i+= imageURLs.length;
	  if (i>=imageURLs.length) i-= imageURLs.length;
	  loadImage(imageURLs[i]);
      }

      function onMaximiseClicked(e) {
	  e.preventDefault();
	  if (!showingImage) return;
	  window.open(showingImage, '_blank').focus();
      }

      window.onscroll = onModalClicked;
      window.onload = function() {
	  imageLoader = document.createElement("IMG");
	  nextImageLoader = document.createElement("IMG");
	  prevImageLoader = document.createElement("IMG");

	  document.getElementById("modal").onclick = onModalClicked;
	  document.getElementById("left").onclick = function(e) { onChangeModal(e,-1); };
	  document.getElementById("right").onclick = function(e) { onChangeModal(e,+1); };
	  document.getElementById("maximise").onclick = onMaximiseClicked;
	  document.addEventListener("keydown", function (e) {
	      if (e.keyCode==37) onChangeModal(e,-1);
	      if (e.keyCode==39) onChangeModal(e,1);
	  });

	  if (window.location.search.length>1)
	      loadAllImages(window.location.search.substr(1));
	  else
	      loadAllImages(".");
	  // Test by loading a single image..
	  /*getImageThumbnail("P1060001.JPG",function(){},function(u) {
	   console.log(u);
	   i = document.createElement("IMG");
	   i.src=u;
	   document.getElementById("thumbs").appendChild(i);
	   });*/
      };

      </script>
    
    <div id="modal" class="fullscreen">
      <div id="bigimage" style="visibility:hidden"></div>
      <div id="loadingimage" style="visibility:hidden"></div>
      <div id="left" style="visibility:hidden">&#9664;</div>
      <div id="right" style="visibility:hidden">&#9654;</div>
      <div id="maximise" style="visibility:hidden">&#x2798;</div>
    </div>
    
</div>
</body>

</html>
